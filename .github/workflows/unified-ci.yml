name: Unified CI (Makefile-based)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

# Security: Read-only permissions for most operations
permissions:
  contents: read
  pull-requests: read

jobs:
  # Job 1: Python Testing (using Makefile)
  python-ci:
    name: Python CI (Make)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: python/pyproject.toml

    - name: Install Python dependencies (via Make)
      run: make python-install

    - name: Run Python tests (via Make)
      run: make python-test-cov

    - name: Run Python linters (via Make)
      run: make python-lint

    - name: Upload coverage to Codecov
      if: success()
      uses: codecov/codecov-action@v5
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./python/coverage.xml
        flags: python
        name: python-coverage
        fail_ci_if_error: false

  # Job 2: JavaScript Testing (using Makefile)
  javascript-ci:
    name: JavaScript CI (Make)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: javascript/package-lock.json

    - name: Install JavaScript dependencies (via Make)
      run: make js-install

    - name: Run JavaScript tests (via Make)
      run: make js-test

    - name: Run JavaScript linter (via Make)
      run: make js-lint

  # Job 3: Full Verification (both languages)
  full-verification:
    name: Full CI Verification
    runs-on: ubuntu-latest
    needs: [python-ci, javascript-ci]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Install all dependencies (via Make)
      run: make install

    - name: Run all tests (via Make)
      run: make test

    - name: Run all linters (via Make)
      run: make lint

    - name: Build all packages (via Make)
      run: make build

    - name: Verify packages (via Make)
      run: make publish-check

    - name: ✅ All checks passed
      run: |
        echo "╔═══════════════════════════════════════════════════╗"
        echo "║                                                   ║"
        echo "║     ✅ ALL CI CHECKS PASSED SUCCESSFULLY ✅      ║"
        echo "║                                                   ║"
        echo "╚═══════════════════════════════════════════════════╝"
